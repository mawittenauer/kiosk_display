<div class="kiosk-header">
  <h1>Information Display</h1>
  <p id="current-time"></p>
</div>

<div class="kiosk-content">
  <div class="module-grid">
    <% @modules.each do |mod| %>
      <div class="module" data-module="<%= mod[:name] %>">
        <%= render partial: mod[:partial], locals: { data: mod[:data] } %>
      </div>
    <% end %>
  </div>
</div>

<script>
  function getWeekdayUTC(dateString) {
    const [year, month, day] = dateString.split('-');
    const utcDate = new Date(Date.UTC(year, month - 1, day + 1));
    return utcDate.toLocaleDateString(undefined, { weekday: 'short' });
  }

  // Update time every second
  function updateTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = 
      now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
  }
  
  updateTime();
  setInterval(updateTime, 1000);
  
  // Auto-refresh modules based on config
  setInterval(() => {
    fetch('/modules/weather/current')
      .then(response => response.json())
      .then(data => {
        // Update weather module
        updateWeatherModule(data);
      })
      .catch(console.error);

      fetch('/modules/weather/forecast')
      .then(response => response.json())
      .then(data => {
        // Update weather forecast
        updateWeatherForecast(data);
      })
      .catch(console.error);
  }, <%= kiosk_config.refresh_interval %>);
  
  function updateWeatherModule(data) {
    const weatherModule = document.querySelector('[data-module="weather"]');
    if (weatherModule) {
      weatherModule.querySelector('.temperature').textContent = data.temperature + '°F';
      weatherModule.querySelector('.description').textContent = data.description;
      weatherModule.querySelector('.humidity').textContent = `Humidity: ${data.humidity + '%'}`;
      weatherModule.querySelector('.last-updated').textContent = 'Updated: ' + data.last_updated;
    }
  }

  function updateWeatherForecast(forecast) {
    const weatherModule = document.querySelector('[data-module="weather"]');
    if (!weatherModule) return;

    const forecastRow = weatherModule.querySelector('.forecast-row');
    if (!forecastRow) return;

    // Clear existing forecast columns
    forecastRow.innerHTML = '';

    // Only show up to 5 days
    forecast.slice(0, 5).forEach(day => {
      const col = document.createElement('div');
      col.className = 'forecast-col';
      col.innerHTML = `
        <div class="forecast-date">${getWeekdayUTC(day.date)}</div>
        <img src="http://openweathermap.org/img/wn/${day.icon}@2x.png" alt="${day.description}">
        <div class="forecast-temp">${day.temperature}°F</div>
        <div class="forecast-desc">${day.description}</div>
      `;
      forecastRow.appendChild(col);
  });
}
</script>
